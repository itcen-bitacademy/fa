<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menu30">


	<select id="listCount" resultType="int"
		parameterType="receiptVo">
		<!-- 페이징 가져오는거 쿼리 넣으세요 -->	
			<![CDATA[
				select   count(*)
			        from tb_voucher_manager as v
			        join tb_voucher_item as i on v.no = i.voucher_no
			        join tb_account as a on a.no = i.account_no
			        join tb_voucher_system_mapping m on m.voucher_no = v.no
    			left join (select no, name
             		 from tb_customer
			             union
			            select no, name
			                  from tb_salescustomer
			             union
			            select no, name
			                  from tb_purchasecustomer
			            ) as cu
			                on cu.no = m.customer_no
			      where v.use_yn = 1
			        and i.use_yn = 1   
           
           
			]]>
		<if test='accountNo!=null and !accountNo.equals("") '>		    
			<![CDATA[
				and account_no = #{accountNo }
			]]>
		</if>
		<if test='customerNo!=null and !customerNo.equals("")'>		    
			<![CDATA[
					and (case char_length(cu.no)
          			 when"07" then (cu.no like '${customerNo }')
           			when "11" then (cu.no like '%${customerNo }%')
           			end) 
			]]>
		</if>
		<if test="regDate!=null and !regDate.equals('')">
			<![CDATA[ 
				and date_format(v.reg_date,'%Y-%m') <= #{regDate }
			]]>
		</if>
	</select>


	<select id="list" resultType="receiptVo" parameterType="map">
		<!-- 리스트 조회하는거 쿼리 넣으세요 -->
	
	<![CDATA[
			select   a.no as accountNo
          , a.name as accountName
          , v.reg_date as regDate
          , i.amount as amount
          , i.amount_flag as amountFlag
          , m.customer_no as customerNo
            , cu.name as customerName
            , m.voucher_use as voucherUse
        from tb_voucher_manager as v
        join tb_voucher_item as i on v.no = i.voucher_no
        join tb_account as a on a.no = i.account_no
        join tb_voucher_system_mapping m on m.voucher_no = v.no
    left join (select no, name
              from tb_customer
             union
            select no, name
                  from tb_salescustomer
             union
            select no, name
                  from tb_purchasecustomer
            ) as cu
                on cu.no = m.customer_no
       where v.use_yn = 1
           and i.use_yn = 1   
           
		   
	]]>
		<if test='vo.accountNo!=null and !vo.accountNo.equals("") '>		    
			<![CDATA[
				and account_no = #{vo.accountNo }
			]]>
		</if>
		<if test='vo.customerNo!=null and !vo.customerNo.equals("")'>		    
			<![CDATA[
				and (case char_length(cu.no)
          			 when"07" then (cu.no like '${vo.customerNo }')
           			when "11" then (cu.no like '%${vo.customerNo }%')
           			end) 
			]]>
		</if>
		<if test="vo.regDate!=null and !vo.regDate.equals('')">
			<![CDATA[ 
				and date_format(v.reg_date,'%Y-%m') <= #{vo.regDate }
			]]>
		</if>
		<![CDATA[
			 order by v.reg_date desc
		]]>
		
		<if test="pagination.pageIndex >= 0 ">
		<![CDATA[
			 limit #{pagination.pageIndex	}, #{pagination.listSize	}
		]]>
		</if>
	</select>


	<select id="statementData" resultType="statementData17Vo">
		<![CDATA[
		select	
				a.no as account_no
				, a.name as account_name
				, sum(i.amount) as amount
				, i.amount_flag as amount_flag
				, a.parent1 as parent1
				, a.parent2 as parent2
				, a.parent3 as parent3
				, a.parent4 as parent4
				, a.parent5 as parent5
				, m.customer_no as customerNo
		  from tb_voucher_manager as v
		  join tb_voucher_item as i on v.no = i.voucher_no
		  join tb_account as a on a.no = i.account_no
		  join tb_voucher_system_mapping m on m.voucher_no = v.no
		 where v.reg_date >= '2019-11-01'
		   and v.reg_date <= '2019-11-31'
		   and v.use_yn = 1
		   and i.use_yn = 1
	  group by 
				a.no
				, a.name
				, i.amount
				, i.amount_flag
				, a.parent1
				, a.parent2
				, a.parent3
				, a.parent4
				, a.parent5
				, m.customer_no
		;
		]]>
	</select>
</mapper>