<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menu50">

	<insert id="insert" parameterType="pdebtvo">
		<![CDATA[
		insert into tb_p_debt
		values (null, #{code }, #{name }, #{debtAmount }, #{debtAmount }, 
				#{repayWay }, #{debtDate }, #{expDate }, #{intRate }, #{intPayWay }, 
				#{intAmount }, #{mgr }, #{mgrCall }, #{dangerCode }, #{dangerName }, 
				#{bankCode }, #{depositNo }, #{accountNo }, #{voucherNo }, 'N', 
				#{insertId }, now(), 0, now())
		]]>
	</insert>
		
	<select id="selectAll" resultType="pdebtvo">
		<![CDATA[
			select 
				no as no, 
				code as code, 
				name as name, 
				major_code as majorCode, 
				debt_amount as debtAmount,
				repay_bal as repayBal, repay_way as repayWay, 
				concat(date_format(debt_date,'%Y-%m-%d'),' - ', date_format(exp_date,'%Y-%m-%d')) as debtExpDate, 
				int_rate as intRate, 
				int_pay_way as intPayWay, 
				int_amount as intAmount, 
				mgr as mgr, mgr_call as mgrCall, danger_code as dangerCode, danger_name as dangerName, 
				bank_code as bankCode, deposit_no as depositNo, account_no as accountNo, 
				voucher_no as voucherNo, delete_flag as deleteFlag, 
				insert_id as insertId, insert_date as insertDate, update_id as updateId,
				update_date as updateDate 
					from tb_p_debt 
						where delete_flag = 'N'
		]]>
			<if test="year.length()>0 ">
				<![CDATA[
				and 	date_format(debt_date,'%Y') like concat('%',#{year},'%') 
				]]>
			</if>
			<if test="code.length()>0 ">
				<![CDATA[
				and 	code like concat('%',#{code},'%') 
				]]>
			</if>
			<if test="pagination.pageIndex >= 0">
				<![CDATA[
			    	limit	 #{pagination.pageIndex }, #{pagination.listSize }
			    ]]>
		    </if>
	</select>
	
	<select id="pdebtTotalcount" parameterType="String" resultType="int">
		<![CDATA[
			select count(*) from tb_p_debt
		]]>
	</select>
	
	<select id="getPdebtInfo" resultType="pdebtvo">
		<![CDATA[
			select 
			no as no, 
			code as code, 
			name as name, 
			major_code as majorCode, 
			debt_amount as debtAmount,
			repay_bal as repayBal, 
			repay_way as repayWay, 
			concat(date_format(debt_date,'%Y-%m-%d'),' - ', date_format(exp_date,'%Y-%m-%d')) as debtExpDate, 
			int_rate as intRate, 
			int_pay_way as intPayWay, 
			int_amount as intAmount, 
			mgr as mgr, mgr_call as mgrCall, danger_code as dangerCode, danger_name as dangerName, 
			bank_code as bankCode, deposit_no as depositNo, account_no as accountNo, 
			voucher_no as voucherNo, delete_flag as deleteFlag, 
			insert_id as insertId, insert_date as insertDate, update_id as updateId,
			update_date as updateDate, 
			date_format(debt_date, '%Y') as financialYear
			from tb_p_debt 
			where code = #{debtcode } 
		]]>
	</select>
	
	<update id="updateDeleteFlag" parameterType="List">
		<![CDATA[
			update tb_p_debt set delete_flag = "Y" where no IN 	
		]]>
		<foreach collection="list" item="item" open="(" close=")" separator=",">
			${item}
		</foreach>
	</update>
	
	<select id="bankList" resultType="bankvo">
		<![CDATA[
			select code, name, store from tb_bank
		]]>
	</select>
	
	<select id="getBankcodeInfo" parameterType="String" resultType="bankvo">
		<![CDATA[
			select code, name, store, mgr, mgr_phone as mgrPhone from tb_bank where code = #{bankcode }
		]]>
	</select>
	
	<select id="getBanknameList" parameterType="String" resultType="bankvo">
		<![CDATA[
			select code, name, store, mgr, mgr_phone as mgrPhone from tb_bank where name = #{bankname }
		]]>
	</select>
	
	<select id="selectAllCount" resultType="int" parameterType="map">
		<![CDATA[
			select count(*)
			    from tb_p_debt
			    where delete_flag= "N"
		]]>
			<if test="year.length() > 0 ">
			<![CDATA[
			and 	date_format(debt_date,'%Y') like concat('%',#{year},'%') 
			]]>
			</if>
			<if test="code.length() > 0 ">
			<![CDATA[
			and 	code like concat('%',#{code},'%') 
			]]>
			</if>
	</select>
	
	
	<!-- update -->
	<update id="update" parameterType="ldebtvo">
		<![CDATA[
			update tb_p_debt 
			set name = #{name},
				major_code = #{majorCode},
				debt_amount = #{debtAmount},
				repay_way=#{repayWay},
				dept_date=#{debtDate},
				exp_date=#{expDate},
				int_rate=#{intRate},
				int_pay_way=#{intPayWay},
				int_amount=#{intAmount},
				mgr=#{mgr},
				mgr_call=#{mgrCall},
				bank_code=#{bankCode},
				deposit_no=#{depositNo},
				update_id='u009',
				update_date=now()
			where no=#{no}
		]]>
	</update>

</mapper>