<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="menu48">
	<!-- Team -->
	<insert parameterType="test4vo" id="save">
	<![CDATA[
		insert
		  into test
		values (null, #{name })
		]]>
	<selectKey order="AFTER" resultType="long" keyProperty="no">
	<![CDATA[
			select last_insert_id()
			]]>
	</selectKey>
	</insert>
	<!-- insert -->
	<insert parameterType="ldebtvo" id="insert">
	<![CDATA[
		insert
		  into tb_l_term_debt
		values (null, #{code},#{name},#{majorCode},#{debtAmount}, 0, #{repayWay}, 'N',#{debtDate}, #{expDate}, #{intRate}, #{intPayWay}, #{intAmount}, #{mgr}, #{mgrCall}, #{bankCode},#{depositNo},'2401101',#{voucherNo},'N',#{insertId},now(),null,null)
		]]>
	<selectKey order="AFTER" resultType="long" keyProperty="no">
	<![CDATA[
			select last_insert_id()
			]]>
	</selectKey>
	</insert>
	
	<!--상환 insert -->
	<insert parameterType="repayvo" id="insertrepay">
	<![CDATA[
		insert
		  into tb_repay
		values (null, #{debtNo},#{payPrinc},#{payDate}, 'L', null,#{depositNo},'N',#{insertId},now(),null,null)
		]]>
	<selectKey order="AFTER" resultType="long" keyProperty="no">
	<![CDATA[
			select last_insert_id()
			]]>
	</selectKey>
	</insert>
	
	
	<select parameterType="map" id="selectAllCount" resultType="int">
	<![CDATA[
		select count(*)
		    from tb_l_term_debt
		    where delete_flag= "N"
	]]>
	<if test="year.length()>0 ">
	<![CDATA[
	and 	date_format(debt_date,'%Y') like concat('%',#{year},'%') 
	]]>
	</if>
	<if test="code.length()>0 ">
	<![CDATA[
		and 	code like concat('%',#{code},'%') 
	]]>
	</if>
	</select>
	<!-- select list -->
	<select parameterType="map" id="selectAll" resultType="ldebtvo">
	<![CDATA[
		select no,
			code,
   			name,
    		major_code as majorCode,
    		debt_amount as debtAmount,
    		repay_bal as repayBal,
    		repay_way as repayWay,
    		concat(date_format(debt_date,'%Y/%m/%d'),'-',
    		date_format(exp_date,'%Y/%m/%d')) as debtExpDate,
    		int_rate as intRate,
    		int_pay_way as intPayWay,
   			mgr,
    		mgr_call as mgrCall,
		    bank_code as bankCode,
		    deposit_no as depositNo
		    from tb_l_term_debt
		    where delete_flag= "N"
	]]>
	<if test="year.length()>0 ">
	<![CDATA[
	and 	date_format(debt_date,'%Y') like concat('%',#{year},'%') 
	]]>
	</if>
	<if test="code.length()>0 ">
	<![CDATA[
		and 	code like concat('%',#{code},'%') 
		]]>
	</if>
	<if test="pagination.pageIndex >= 0">
	<![CDATA[
                limit    #{pagination.pageIndex }, #{pagination.listSize }
             ]]>
	</if>
	</select>
	<select id="selectsection" resultType="sectionvo">
	<![CDATA[
		select no,
			classification,
			code,
			last_update as lastUpdate,
			parent_no as parentNo
		    from tb_section
		    where parent_no= 6
	]]>
	</select>
	<!-- 상환후 갱신된 정보 select -->
	<select parameterType="long" id="selectone" resultType="ldebtvo">
	<![CDATA[
		select no,
			code,
   			name,
    		major_code as majorCode,
    		debt_amount as debtAmount,
    		repay_bal as repayBal,
    		repay_way as repayWay,
    		concat(date_format(debt_date,'%Y/%m/%d'),'-',
    		date_format(exp_date,'%Y/%m/%d')) as debtExpDate,
    		int_rate as intRate,
    		int_pay_way as intPayWay,
   			mgr,
    		mgr_call as mgrCall,
		    bank_code as bankCode,
		    deposit_no as depositNo
		    from tb_l_term_debt
		    where no=#{_parameter}
	]]>
	</select>
	
	<!-- update -->
	<update parameterType="ldebtvo" id="update">
	<![CDATA[
		update tb_l_term_debt 
		set name = #{name},
			major_code = #{majorCode},
			debt_amount = #{debtAmount},
			repay_way=#{repayWay},
			debt_date=#{debtDate},
			exp_date=#{expDate},
			int_rate=#{intRate},
			int_pay_way=#{intPayWay},
			int_amount=#{intAmount},
			mgr=#{mgr},
			mgr_call=#{mgrCall},
			bank_code=#{bankCode},
			deposit_no=#{depositNo},
			update_id=#{updateId},
			update_date=now()
		where no=#{no}
	]]>
	</update>
	<!-- select no -->	
	<select parameterType="long" id="selectno" resultType="long">
	<![CDATA[
		select voucher_no
		from tb_l_term_debt
		where no=#{_parameter}
	]]>
	</select>
	<!-- delete -->
	<update parameterType="list" id="delete">
	<![CDATA[
		update tb_l_term_debt 
		set delete_flag='Y'
		where no in 
	]]>
	<foreach separator="," open="(" close=")" collection="list" index="index" item="item">
		#{item } 
	</foreach>
	</update>
	
	
	<!-- 상환 update -->
	<update parameterType="repayvo" id="repayupdate">
	<![CDATA[
		update tb_l_term_debt 
		set repay_bal = repay_bal + #{payPrinc}	
		where no=#{debtNo}
	]]>
	</update>
	
	
</mapper>