<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menu55">
	<!-- Team -->
	<insert id="save" parameterType="test12vo">
		<![CDATA[
		insert
		  into test
		values (null, #{name })
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">
			<![CDATA[
			select last_insert_id()
			]]>
		</selectKey>
	</insert>
	
	<select id="getList" resultType="currentsituationvo" parameterType="currentsituationvo">
	<![CDATA[
    select 
		  pi.no as itemcode
          , pi.name as itemname
          , s.quantity as purchasemanagementquantity
          , s.supply_value as purchasemanagementsupplyvalue
          , s.tax_value as purchasemanagementtaxvalue
          , s.total_price as purchasemanagementtotalprice
          , s.sales_date as salesdate
		  , p.quantity as salesquantity
          , p.supply_value as salessupplyvalue
          , p.tax_value as salestaxvalue
          , p.total_price as salestotalprice
          , p.purchase_date as purchasedate
    from tb_purchaseitem_test as pi 
    left join(
			select 
			s1.item_code as item_code
			, s1.item_name as item_name
			, sum(s1.quantity) as quantity
			, sum(s1.supply_value) as supply_value
			, sum(s1.tax_value) as tax_value
			, sum(s1.total_price) as total_price
			, s1.sales_date as sales_date
		from tb_sales_test as s1
        where 1=1
        and date_format(s1.sales_date,'%Y-%m') like concat('%',#{searchdate },'%')
		group by s1.item_name
		)as s on pi.no = s.item_code
	left join(
			select	
			p1.item_code as item_code
			, p1.item_name as item_name
			, sum(p1.quantity) as quantity
			, sum(p1.supply_value) as supply_value
			, sum(p1.tax_value) as tax_value
			, sum(p1.total_price) as total_price
			, p1.purchase_date as purchase_date
		  from	tb_purchasemanagement_test as p1
          where 1=1
          and date_format(p1.purchase_date,'%Y-%m') like concat('%',#{searchdate },'%')
	     group	by p1.item_name
        )as p on pi.no = p.item_code
		where(p.quantity is not null 
        or s.quantity is not null)
        ]]>
        <if test="itemcode!=null and !itemcode.equals('')">
		<![CDATA[
   		and pi.no = #{itemcode}
		]]>        
        </if>



	</select>
	<!-- 	품목명을 가져오는 코드 -->
	<select id="getitemcode" resultType="currentsituationvo">
	<![CDATA[
	select 
		   no as itemcode
		   , name as itemname
    from tb_purchaseitem_test;
	]]>
	</select>

</mapper>