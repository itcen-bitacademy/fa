<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menu41">

	<!--  TEST -->
	<insert id="save" parameterType="test08vo">
		<![CDATA[
		insert
		  into test
		values (null, #{name })
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">
			<![CDATA[
			select last_insert_id()
			]]>
		</selectKey>
	</insert>
	
	<!-- 대분류 리스트 TEST -->
	<select id="section"  resultType="sectionvo">
		<![CDATA[
		select no as no,
			   code as code,
			   classification as classification
		from tb_section
		where parent_no = 4;  
		]]>
	</select>
	
	<!-- 직급 리스트 TEST -->
	<select id="name"  resultType="name">
		<![CDATA[
		select no,
			  staff_name as staffName 
		from tb_staff;
		]]>
	</select>
	
	<!-- 거래처 리스트 TEST -->
	<select id="customer"  resultType="1customervo">
		<![CDATA[
		 select no, 
		 		manager_name as managerName, 
		 		name
          from tb_customer 
          where assets_flag = "a";
		]]>
	</select>
	
	<!-- 등록 TEST -->
	<insert id="insert" parameterType="vehicle08vo">
		<![CDATA[
		insert
		  into tb_vehicle
		values (#{id },
				#{customerNo}, 
				null, 
				null, 
				#{sectionNo},
				#{staffNo},
				#{ownerName},
				null,
				null,
				null,
				null,
				#{publicValue},
				#{regTax},
				#{acqTax},
				#{etcCost},
				#{payDate},
				#{deposit},
				#{depositDate},
				#{monthlyFee},
				#{feeDate}, 
				#{taxKind}, 
				"s", 
				#{insertUserId}, 
				now(), 
				null, 
				null
				);
		]]>
		<selectKey keyProperty="id" resultType="string" order="AFTER">
			<![CDATA[
			select last_insert_id()
			]]>
		</selectKey>
	</insert>
	
	<!-- 등록된거 조회 리스트 TEST -->
	<select id="select"  resultType="vehicle08vo">
		<![CDATA[
			select  
					v.id as id,
					v.customer_no as customerNo,
					c.name as customerName,
					c.manager_name as managerName, 
					v.section_no as sectionNo,
					s.classification as classification,
					st.staff_name as staffName,
					v.owner_name as ownerName,
					v.public_value as publicValue,
					v.reg_tax as regTax,
					v.acq_tax as acqTax,
					v.etc_cost as etcCost,
					v.taxbill_no as taxbillNo,
					v.pay_date as payDate,
					v.deposit as deposit,
					v.deposit_date as depositDate,
					v.monthly_fee as monthlyFee,
					v.fee_date as feeDate,
					v.tax_kind as taxKind,
                    v.insert_userid as insertUserId,
                    v.insert_day as insertDay
		from tb_vehicle v 
				 left outer join tb_staff st on v.staff_no = st.no
				 left outer join tb_section s on v.section_no = s.code 
                 left outer join user u on v.insert_userid = u.id
                 left outer join tb_customer c on v.customer_no = c.no
		where s.parent_no=4 and v.insert_day > (NOW() - INTERVAL 3 DAY) and flag IN('s','o')
		order by v.insert_day desc;
	
		]]>
	</select>
		<!-- limit 0,3; -->
	
	<!-- 수정 TEST --><!-- where 조건절에 행이 선택되어있을경우 set flag="o"로 바꾸고 -->
	<update id="update" parameterType="vehicle08vo">
		<![CDATA[
		update tb_vehicle
		  set 
		  	  customer_no = #{customerNo},
		  	  taxbill_no = #{taxbillNo},
		  	  voucher_no = null,
		  	  section_no = #{sectionNo},
		  	  staff_no = #{staffNo},
		  	  owner_name = #{ownerName},
		  	  wide_address = null,
		  	  city_address = null,
		  	  local_address = null,
		  	  detail_address = null,
		  	  public_value = #{publicValue},
		  	  reg_tax = #{regTax},
		  	  acq_tax = #{acqTax},
		  	  etc_cost = #{etcCost},
		  	  pay_date = #{payDate},
		  	  deposit =  #{deposit},
			  deposit_date = #{depositDate},
			  monthly_fee = #{monthlyFee},
			  fee_date = #{feeDate},
			  tax_kind = #{taxKind},
			  flag = "o",
			  update_userid = #{updateUserId},
			  update_day = now()
	    where id = #{id }; 
		]]>
	</update>
 	
 	<!-- 거래처번호를 통해 계좌번호 가져오기 -->
	<select id="getDepositNo" parameterType="string" resultType="string">
		<![CDATA[
		select deposit_no
		  from tb_customer
		 where no = #{customerNo}
		]]>
	</select>
 
	
	<!-- 삭제 TEST --><!--  삭제버튼 클릭시 flag="s"를 flag="d"로 바꾸면서 삭제-->

	<update id="delete" parameterType="string">
		<![CDATA[
		update tb_vehicle
		  set flag="d",
		  	  update_userid = #{updateUserId},
			  update_day = now()
	    where id = #{id}; 
		]]>
	</update>
 
 
 	<!-- 검색  TEST -->
	<select id="search" resultType="vehicle08vo">
		<![CDATA[
		select  	v.id as id,
					v.section_no as sectionNo,
					s.classification as classification,
					st.staff_name as staffName,
					v.owner_name as ownerName,
					v.public_value as publicValue,
					v.reg_tax as regTax,
					v.acq_tax as acqTax,
					v.etc_cost as etcCost,
					v.pay_date as payDate,
					v.deposit as deposit,
					v.deposit_date as depositDate,
					v.monthly_fee as monthlyFee,
					v.fee_date as feeDate,
					v.tax_kind as taxKind,
					v.insert_day as insertDay
		from tb_vehicle v 
				 left outer join tb_staff st on v.staff_no = st.no
				 left outer join tb_section s on v.section_no = s.code 
		 ]]>
		 <![CDATA[
		where s.parent_no=4 and v.insert_day > (NOW() - INTERVAL 3 DAY) and flag IN('s','o')
		]]>
		<if test="_parameter.length()>0">
            <![CDATA[
              and id like concat('%',#{_parameter },'%') 
            ]]>
         </if>
	</select>
	
</mapper>