<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="menu46">
	<resultMap type="stermdebtvo" id="stermdebtResult">
		<result column="major_code" property="majorCode"/>
		<result column="debt_amount" property="debtAmount" />
		<result column="repay_bal" property="repayBal" />
		<result column="repay_way" property="repayWay" />
		<result column="repay_compl_flag" property="repayComplFlag" />
		<result column="debt_date" property="debtDate" />
		<result column="exp_date" property="expDate" />
		<result column="int_rate" property="intRate" />
		<result column="int_pay_way" property="intPayWay" />
		<result column="bank_code" property="bankCode" />
		<result column="deposit_no" property="depositNo" />
		<result column="voucher_no" property="voucherNo" />
		<result column="delete_flag" property="deleteFlag" />
		<result column="insert_id" property="insertId" />
		<result column="insert_date" property="insertDate" />
		<result column="update_id" property="updateId" />
		<result column="update_date" property="updateDate" />
	</resultMap>
	
	<select id="getList" parameterType="Map" resultType="stermdebtvo" resultMap="stermdebtResult">
		<![CDATA[
			select 
			no, code, major_code, name,
			debt_amount, repay_bal, repay_way,
			date_format(debt_date, "%Y-%m-%d") debt_date, date_format(exp_date, "%Y-%m-%d") exp_date, int_rate,
			int_pay_way, mgr,
			mgr_call, bank_code, deposit_no, 
			voucher_no, delete_flag,
			insert_id, insert_date, update_id,
			update_date 
			from tb_s_term_debt
			where delete_flag="N" and repay_comple_flag="N"
		]]>
		<if test='code != null and !"".equals(code)'>
			and code LIKE CONCAT(#{code}, "%")
		</if>
		<if test='financialYear != null and !"".equals(financialYear)'>
			and year(debt_date) = #{financialYear} 
		</if>
		limit ${startRow}, ${pageSize}
	</select>
	
	<select id="getTotalCnt" parameterType="map" resultType="int">
		<![CDATA[
			select count(*) 
			from tb_s_term_debt
			where delete_flag="N" and repay_comple_flag="N"
		]]>
		<if test='code != null and !"".equals(code)'>
			and code LIKE CONCAT(#{code}, '%')
		</if>
		<if test='financialYear != null and !"".equals(financialYear)'>
			and year(debt_date) = #{financialYear}
		</if>
	</select>
	<insert id="insert" parameterType="stermdebtvo">
		<![CDATA[
			insert into tb_s_term_debt(no, code, name, major_code, debt_amount, repay_bal, repay_way,
			debt_date, exp_date, int_rate, int_pay_way, mgr,
			mgr_call, bank_code, deposit_no, voucher_no, 
			delete_flag,insert_id, insert_date, update_id, update_date)
			values (null, #{code }, #{name }, #{majorCode}, ${debtAmount }, 
			${debtAmount }, #{repayWay }, #{debtDate}, #{expDate},
			${intRate }, #{intPayWay }, #{mgr }, 
			#{mgrCall }, #{bankCode },
			#{depositNo }, ${voucherNo}, 
			'N', #{insertId }, now(), null, null) 
		]]>
	</insert>
	
	<update id="update" parameterType="stermdebtvo">
		<![CDATA[
			update tb_s_term_debt 
			set code=#{code}, name=#{name}, major_code=#{majorCode}, debt_amount=${debtAmount}, repay_way=#{repayWay}, 
			    debt_date=now(), exp_date=now(), int_rate=${intRate}, int_pay_way=#{intPayWay},
			    mgr=#{mgr }, mgr_call=#{mgrCall}, bank_code=#{bankCode}, deposit_no=#{depositNo}, update_id=#{updateId}, update_date=now()
			where no=${no }
		]]>
	</update>
	
	<update id="updateDeleteFlag" parameterType="List">
		<![CDATA[
			update tb_s_term_debt
			set delete_flag = "Y"
			where no IN 	
		]]>
		<foreach collection="list" item="item" open="(" close=")" separator=",">
			${item}
		</foreach>
	</update>
	
	<update id="updateRepayBal" parameterType="repayvo">
		<![CDATA[
			update tb_s_term_debt 
			set repay_bal = repay_bal - ${payPrinc} 
			where no = ${debtNo}
		]]>
	</update>
	
	<insert id="insertRepay" parameterType="repayvo">
		<![CDATA[
			insert into tb_repay(no, debt_no, pay_prinv, int_amount, pay_date, debt_type, voucher_no, delete_flag, insert_id, insert_date)
			values(null, ${debtNo}, ${payPrinc}, ${intAmount}, #{payDate}, #{debtType}, ${voucherNo}, "N", #{insertId}, now())
		]]>
	</insert>
</mapper>